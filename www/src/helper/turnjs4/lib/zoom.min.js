/* turn.js r4 | zoom.js | Copyright (c) 2012 Emmanuel Garcia | turnjs.com | turnjs.com/legal.txt */
(function(f){function q(a,b){return a[0]==b[0]?!1:a.attr("page")?!0:a.parent()[0]?q(a.parent(),b):!1}function p(a){function b(a){this.name="TurnJsError";this.message=a}b.prototype=Error();b.prototype.constructor=b;return new b(a)}function r(a,b,c){return n&&c?" translate3d("+a+"px,"+b+"px, 0px) ":" translate("+a+"px, "+b+"px) "}function t(a,b){return n&&b?" scale3d("+a+", "+a+", 1) ":" scale("+a+") "}function g(a,b){return{x:a,y:b}}var n,u={max:2,flipbook:null,easeFunction:"ease-in-out",duration:500,
when:{}},l={init:function(a){var b=this,c=this.data(),a=f.extend(u,a);if(!a.flipbook||!a.flipbook.turn("is"))throw p("options.flipbook is required");n="WebKitCSSMatrix"in window||"MozPerspective"in document.body.style;if("function"!=typeof a.max){var d=a.max;a.max=function(){return d}}c.zoom={opts:a,axis:g(0,0),scrollPos:g(0,0),eventQueue:[],eventZoom:function(){return l._eZoom.apply(b,arguments)},eventStart:function(){return l._eStart.apply(b,arguments)},eventTurning:function(){return l._eTurning.apply(b,
arguments)},eventTurned:function(){return l._eTurned.apply(b,arguments)},mouseupEvent:function(){return l._eMouseUp.apply(b,arguments)},eventTouchStart:function(){return l._eTouchStart.apply(b,arguments)},eventTouchMove:function(){return l._eTouchMove.apply(b,arguments)},eventTouchEnd:function(){return l._eTouchEnd.apply(b,arguments)}};for(var e in a.when)Object.prototype.hasOwnProperty.call(a.when,e)&&this.bind("zoom."+e,a.when[e]);a.flipbook.bind("zooming",c.zoom.eventZoom).bind("start",c.zoom.eventStart).bind("turning",
c.zoom.eventTurning).bind("turned",c.zoom.eventTurned);this.css({position:"relative",overflow:"hidden"});f.isTouch?(a.flipbook.bind("touchstart",c.zoom.eventTouchStart).bind("touchmove",c.zoom.eventTouchMove).bind("touchend",c.zoom.eventTouchEnd),this.bind("touchstart",l._tap)):this.click(l._tap)},_tap:function(a){var b=f(this);b.data();q(f(a.target),b)&&(l._addEvent.call(b,"tap",a),(a=l._eventSeq.call(b))&&b.trigger(a))},_addEvent:function(a,b){var c=this.data().zoom,d=(new Date).getTime();c.eventQueue.push({name:a,
timestamp:d,event:b});10<c.eventQueue.length&&c.eventQueue.splice(0,1)},_eventSeq:function(){var a=this.data().zoom.eventQueue,b=a.length-1;if(0<b&&"tap"==a[b].name&&"tap"==a[b-1].name&&a[b].event.pageX==a[b-1].event.pageX&&a[b].event.pageY==a[b-1].event.pageY&&200>a[b].timestamp-a[b-1].timestamp&&50<a[b].timestamp-a[b-1].timestamp)return f.extend(a[b].event,{type:"zoom.doubleTap"});if("tap"==a[b].name)return f.extend(a[b].event,{type:"zoom.tap"})},_prepareZoom:function(){var a,b=this.data().zoom,
c=1/this.zoom("value");a=b.opts.flipbook;var d=a.data(),e=a.offset(),h=this.offset(),j={height:a.height()},i=a.turn("view");"double"==a.turn("display")&&a.data().opts.autoCenter?i[0]?(j.width=i[1]?a.width():a.width()/2,a=g(e.left-h.left,e.top-h.top)):(j.width=a.width()/2,a=g(e.left-h.left+j.width,e.top-h.top)):(j.width=a.width(),a=g(e.left-h.left,e.top-h.top));b.zoomer||(b.zoomer=f("<div />",{"class":"zoomer",css:{overflow:"hidden",position:"absolute",zIndex:"1000000"}}).mousedown(function(){return!1}).appendTo(this));
b.zoomer.css({top:a.y,left:a.x,width:j.width,height:j.height});e=i.join(",");if(e!=b.zoomerView){b.zoomerView=e;b.zoomer.find("*").remove();for(e=0;e<i.length;e++)if(i[e]){var h=d.pageObjs[i[e]].offset(),k=f(d.pageObjs[i[e]]);k.clone().transform("").css({width:k.width()*c,height:k.height()*c,position:"absolute",display:"",top:(h.top-a.y)*c,left:(h.left-a.x)*c}).appendTo(b.zoomer)}}return{pos:a,size:j}},value:function(){return this.data().zoom.opts.flipbook.turn("zoom")},zoomIn:function(a){var b=this,
c=this.data().zoom,d=c.opts.flipbook;d.offset();var e=this.offset(),h=l._prepareZoom.call(this),j=h.pos,i=g(h.size.width/2,h.size.height/2),k=c.opts.max(),n=f.cssPrefix(),s=f.cssTransitionEnd(),q=d.data().opts.autoCenter;c.scale=k;d.data().noCenter=!0;a="undefined"!=typeof a?"x"in a&&"y"in a?g(a.x-j.x,a.y-j.y):f.isTouch?g(a.originalEvent.touches[0].pageX-j.x-e.left,a.originalEvent.touches[0].pageY-j.y-e.top):g(a.pageX-j.x-e.left,a.pageY-j.y-e.top):g(i.x,i.y);if(0>a.x||0>a.y||a.x>h.width||a.y>h.height)a.x=
i.x,a.y=i.y;var o=g((a.x-i.x)*k+i.x,(a.y-i.y)*k+i.y),a=g(h.size.width*k>this.width()?a.x-o.x:0,h.size.height*k>this.height()?a.y-o.y:0),o=g(Math.abs(h.size.width*k-this.width()),Math.abs(h.size.height*k-this.height())),h=g(Math.min(0,h.size.width*k-this.width()),Math.min(0,h.size.height*k-this.height())),m=g(i.x*k-i.x-j.x-a.x,i.y*k-i.y-j.y-a.y);m.y>o.y?a.y=m.y-o.y+a.y:m.y<h.y&&(a.y=m.y-h.y+a.y);m.x>o.x?a.x=m.x-o.x+a.x:m.x<h.x&&(a.x=m.x-h.x+a.x);m=g(i.x*k-i.x-j.x-a.x,i.y*k-i.y-j.y-a.y);j={};j[n+"transition"]=
n+"transform "+c.opts.easeFunction+" "+c.opts.duration+"ms";var p=function(){b.trigger("zoom.zoomIn");c.zoomIn=!0;c.flipTop=d.css("top");c.flipLeft=d.css("left");d.turn("zoom",k).css({position:"absolute",margin:"",top:0,left:0});var a=d.offset();c.axis=g(a.left-e.left,a.top-e.top);q&&"double"==d.turn("display")&&!d.turn("view")[0]&&(c.axis.x+=d.width()/2);b.zoom("scroll",m);b.bind(f.mouseEvents.down,l._eMouseDown);b.bind(f.mouseEvents.move,l._eMouseMove);f(document).bind(f.mouseEvents.up,c.mouseupEvent);
b.bind("mousewheel",l._eMouseWheel);setTimeout(function(){c.zoomer.hide();c.zoomer.remove();c.zoomer=null;c.zoomerView=null},50)};c.zoomer.css(j).show();s?c.zoomer.bind(s,function(){f(this).unbind(s);p()}):setTimeout(p,c.opts.duration);c.zoomer.transform(r(a.x,a.y,!0)+t(k,!0))},zoomOut:function(){var a,b=this,c=this.data().zoom,d=c.opts.flipbook,e=c.scale,h=f.cssPrefix(),j=f.cssTransitionEnd();if(c.zoomIn){c.zoomIn=!1;c.scale=1;d.data().noCenter=!1;b.unbind(f.mouseEvents.down,l._eMouseDown);b.unbind(f.mouseEvents.move,
l._eMouseMove);f(document).unbind(f.mouseEvents.up,c.mouseupEvent);b.unbind("mousewheel",l._eMouseWheel);a={};a[h+"transition"]=h+"transform "+c.opts.easeFunction+" "+c.opts.duration+"ms";d.css(a);a=g(-d.width()/2,-d.height()/2);var i=d.data().opts.autoCenter;i&&"double"==d.turn("display")&&(d.turn("view")[0]?d.turn("view")[1]||(a.x+=d.width()/(4*e)):a.x-=d.width()/(4*e));var k=function(){d[0].style.removeProperty?(d[0].style.removeProperty(h+"transition"),d.transform("none").turn("zoom",1),d[0].style.removeProperty("margin"),
d.css({top:c.flipTop,left:c.flipLeft})):d.transform("none").turn("zoom",1).css({margin:"",top:c.flipTop,left:c.flipLeft});i&&d.turn("center");b.trigger("zoom.zoomOut")};j?d.bind(j,function(){f(this).unbind(j);k()}):setTimeout(k,c.opts.duration);d.transform(r(a.x,a.y,!0)+t(1/e,!0))}},flipbookWidth:function(){var a=this.data().zoom.opts.flipbook,b=a.turn("view");return"double"==a.turn("display")&&(!b[0]||!b[1])?a.width()/2:a.width()},scroll:function(a,b,c){var d=this.data().zoom,e=d.opts.flipbook,h=
this.zoom("flipbookWidth"),j=f.cssPrefix();if(n){var i={};i[j+"transition"]=c?j+"transform 200ms":"none";e.css(i);e.transform(r(-d.axis.x-a.x,-d.axis.y-a.y,!0))}else e.css({top:-d.axis.y-a.y,left:-d.axis.x-a.x});if(!b){var k,b=g(Math.min(0,(h-this.width())/2),Math.min(0,(e.height()-this.height())/2)),e=g(h>this.width()?h-this.width():(h-this.width())/2,e.height()>this.height()?e.height()-this.height():(e.height()-this.height())/2);a.y<b.y?(a.y=b.y,k=!0):a.y>e.y&&(a.y=e.y,k=!0);a.x<b.x?(a.x=b.x,k=
!0):a.x>e.x&&(a.x=e.x,k=!0);k&&this.zoom("scroll",a,!0,!0)}d.scrollPos=g(a.x,a.y)},resize:function(){var a=this.data().zoom,b=a.opts.flipbook;if(1<this.zoom("value")){var c=b.offset(),d=this.offset();a.axis=g(c.left-d.left+(a.axis.x+a.scrollPos.x),c.top-d.top+(a.axis.y+a.scrollPos.y));"double"==b.turn("display")&&!b.turn("view")[0]&&(a.axis.x+=b.width()/2);this.zoom("scroll",a.scrollPos)}},_eZoom:function(){for(var a=this.data().zoom,b=a.opts.flipbook,c=b.turn("view"),d=0;d<c.length;d++)c[d]&&this.trigger("zoom.resize",
[a.scale,c[d],b.data().pageObjs[c[d]]])},_eStart:function(a){1!=this.zoom("value")&&a.preventDefault()},_eTurning:function(a,b,c){var d=this,a=this.zoom("value"),e=this.data().zoom,b=e.opts.flipbook;e.page=b.turn("page");if(1!=a){for(e=0;e<c.length;e++)c[e]&&this.trigger("zoom.resize",[a,c[e],b.data().pageObjs[c[e]]]);setTimeout(function(){d.zoom("resize")},0)}},_eTurned:function(a,b){if(1!=this.zoom("value")){var c=this.data().zoom,d=c.opts.flipbook;b>c.page?this.zoom("scroll",g(0,c.scrollPos.y),
!1,!0):b<c.page&&this.zoom("scroll",g(d.width(),c.scrollPos.y),!1,!0)}},_eMouseDown:function(a){var b=f(this).data().zoom;b.dragging=!0;b.draggingCur=f.isTouch?g(a.originalEvent.touches[0].pageX,a.originalEvent.touches[0].pageY):g(a.pageX,a.pageY);return!1},_eMouseMove:function(a){var b=f(this).data().zoom;if(b.dragging){var a=f.isTouch?g(a.originalEvent.touches[0].pageX,a.originalEvent.touches[0].pageY):g(a.pageX,a.pageY),c=g(a.x-b.draggingCur.x,a.y-b.draggingCur.y);f(this).zoom("scroll",g(b.scrollPos.x-
c.x,b.scrollPos.y-c.y),!0);b.draggingCur=a;return!1}},_eMouseUp:function(){var a=f(this).data().zoom;a.dragging&&f(this).zoom("scroll",a.scrollPos);a.dragging=!1},_eMouseWheel:function(a,b,c,d){a=f(this).data().zoom;c=g(a.scrollPos.x+10*c,a.scrollPos.y-10*d);f(this).zoom("scroll",c,!1,!0)},_eTouchStart:function(a){var b=f(this).data().zoom,a=g(a.originalEvent.touches[0].pageX,a.originalEvent.touches[0].pageY);b.touch={};b.touch.initial=a;b.touch.last=a;b.touch.timestamp=(new Date).getTime();b.touch.speed=
g(0,0)},_eTouchMove:function(a){var b=f(this).data().zoom,c=f(this).zoom("value"),d=b.opts.flipbook,e=(new Date).getTime(),a=g(a.originalEvent.touches[0].pageX,a.originalEvent.touches[0].pageY);b.touch&&1==c&&!d.data().mouseAction&&(b.touch.motion=g(a.x-b.touch.last.x,a.y-b.touch.last.y),b.touch.speed.x=0===b.touch.speed.x?b.touch.motion.x/(e-b.touch.timestamp):(b.touch.speed.x+b.touch.motion.x/(e-b.touch.timestamp))/2,b.touch.last=a,b.touch.timestamp=e)},_eTouchEnd:function(){var a=f(this).data().zoom;
if(a.touch&&1==f(this).zoom("value")){var b=Math.abs(a.touch.initial.y-a.touch.last.y);50>b&&(-1>a.touch.speed.x||-100>a.touch.last.x-a.touch.initial.x)?this.trigger("zoom.swipeLeft"):50>b&&(1<a.touch.speed.x||100<a.touch.last.x-a.touch.initial.x)&&this.trigger("zoom.swipeRight")}}};f.extend(f.fn,{zoom:function(){var a=arguments;if(!a[0]||"object"==typeof a[0])return l.init.apply(f(this[0]),a);if(l[a[0]])return l[a[0]].apply(f(this[0]),Array.prototype.slice.call(a,1));throw p(a[0]+" is not a method");
}})})(jQuery);
